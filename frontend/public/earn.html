<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Tube - Tasks & Rewards</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #00ff88;
            --primary-hover: #00cc66;
            --bg-color: #121212;
            --card-bg: rgba(255,255,255,0.05);
            --text-primary: #fff;
            --text-secondary: #bdbdbd;
            --border-color: rgba(255,255,255,0.1);
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        padding-bottom: 70px;
    }

        .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

        /* Task Categories */
        .task-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .category-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        padding: 20px;
        text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .category-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
        }

        .category-card i {
        font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .category-card h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .category-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Progress Section */
        .progress-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        padding: 20px;
            margin-bottom: 25px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        margin-bottom: 15px;
    }

        .progress-title {
        font-size: 1.2rem;
            color: var(--primary-color);
        }

        .progress-stats {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #00cc66);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Task List */
        .task-list {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item:hover {
            background: rgba(255,255,255,0.02);
        }

        .task-icon {
            width: 40px;
            height: 40px;
            background: rgba(0,255,136,0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .task-icon i {
            color: var(--primary-color);
        font-size: 1.2rem;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-title {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .task-reward {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.1rem;
            margin-left: 15px;
        }

        .task-button {
            background: var(--primary-color);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .task-button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .task-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Streak Section */
        .balance-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .balance-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .level-title {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .level-amount {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all var(--transition-speed);
        }

        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 4px;
            transition: transform var(--transition-speed);
        }

        .nav-item:hover {
            color: var(--primary-color);
            background: rgba(0, 255, 136, 0.1);
        }

        .nav-item:hover i {
            transform: translateY(-2px);
        }

        .nav-item.active {
            color: var(--primary-color);
            background: rgba(0, 255, 136, 0.1);
        }

        .nav-item.active i {
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .task-categories {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            .task-item {
                flex-direction: column;
                text-align: center;
            }

            .task-icon {
                margin: 0 auto 10px;
            }

            .task-reward {
                margin: 10px 0;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 80%;
            max-width: 400px;
            position: relative;
            z-index: 1001;
            box-shadow: 0 0 20px rgba(0,255,136,0.2);
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        #captchaContent {
            margin: 20px 0;
            text-align: center;
            font-size: 32px;
            letter-spacing: 5px;
            color: var(--primary-color);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0,255,136,0.3);
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
        }

        #captchaInput {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
        }

        #captchaInput:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 10px rgba(0,255,136,0.2);
        }

        .modal-content button {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .modal-content button:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .task-limit-message {
            color: #ff5252;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .task-reset-time {
            color: var(--text-secondary);
        text-align: center;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .close {
            position: absolute;
            top: 18px;
            right: 22px;
            font-size: 2.2rem;
            font-weight: 900;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1100;
            transition: color 0.2s, transform 0.2s;
            text-shadow: 0 0 10px #00ff88, 0 0 2px #000;
            line-height: 1;
        }

        .close:hover {
            color: var(--primary-color);
            transform: scale(1.2) rotate(10deg);
    }
    </style>
</head>
<body>
    <div class="container">
        <!-- Balance and Level Section -->
        <div class="balance-section" id="balanceSection">
            <div class="balance-title">Current Balance</div>
            <div class="balance-amount" id="balanceAmount">$0.00</div>
            <div class="level-title">Current Level</div>
            <div class="level-amount" id="levelAmount">-</div>
        </div>
        <div id="noPackageMsg" style="display:none; color:#ff5252; text-align:center; margin:20px 0;">
            You need an active package to complete tasks.
        </div>

        <!-- Task Reset Timer -->
        <div id="taskResetTimer" style="display:none; text-align:center; font-size:1.2rem; font-weight:bold; margin-bottom:15px; color:var(--primary-color);"></div>

        <!-- Task List -->
        <div class="task-list" id="taskList" style="display:none;">
            <!-- Tasks will be rendered here by JavaScript -->
        </div>

        <!-- Captcha Modal -->
        <div id="captchaModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" tabindex="0" aria-label="Close">&times;</span>
                <h3>Solve Captcha</h3>
                <div id="captchaContent"></div>
                <input type="text" id="captchaInput" placeholder="Enter the text" maxlength="6">
                <button onclick="verifyCaptcha()">Submit</button>
                <div class="task-limit-message" id="taskLimitMessage" style="display: none;">
                    You've reached your daily task limit!
                </div>
                <div class="task-reset-time" id="taskResetTime"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="home.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="earn.html" class="nav-item active">
            <i class="fas fa-tasks"></i>
            <span>Task</span>
        </a>
        <a href="refferal.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Team</span>
        </a>
        <a href="vip.html" class="nav-item">
            <i class="fas fa-crown"></i>
            <span>VIP</span>
        </a>
        <a href="me.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Me</span>
        </a>
    </div>

    <script>
        const API_URL = window.location.origin + '/api'; // Use the current origin for API calls

        // Function to update the displayed task list based on completed tasks
        function updateTaskList(completedTasks) {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = ''; // Clear current tasks
            const tasksToShow = 5 - completedTasks;

            if (tasksToShow <= 0) {
                taskList.style.display = 'none';
                const noPackageMsg = document.getElementById('noPackageMsg');
                noPackageMsg.textContent = 'You have completed all tasks for today!';
                noPackageMsg.style.display = '';
            } else {
                // Render remaining tasks
                for (let i = 1; i <= tasksToShow; i++) {
                    taskList.innerHTML += `
                        <div class="task-item" id="captcha${completedTasks + i}">
                            <div class="task-icon">
                                <i class="fas fa-puzzle-piece"></i>
                            </div>
                            <div class="task-content">
                                <div class="task-title">Solve Captcha</div>
                                <div class="task-description">Type the text shown in the image</div>
                            </div>
                            <div class="task-reward">+$0.13</div>
                            <button class="task-button" onclick="showCaptcha('captcha${completedTasks + i}')">Solve</button>
                        </div>
                    `;
                }
                taskList.style.display = '';
                document.getElementById('noPackageMsg').style.display = 'none';
            }
        }

        // Load initial state: check package, level, and tasks
        async function loadTaskState() {
            try {
                // Fetch user profile (contains activePackage and level)
                const profileResponse = await fetch(`${API_URL}/users/profile`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const profileData = await profileResponse.json();

                // Fetch task progress (contains completedTasks)
                const progressResponse = await fetch(`${API_URL}/tasks/progress`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const progressData = await progressResponse.json();

                const user = profileData.user;
                const completedTasks = progressData.success ? progressData.completedTasks : 0;

                // Update balance and level display
                if (profileData.success && user) {
                     document.getElementById('balanceAmount').textContent = `$${parseFloat(user.balance || 0).toFixed(2)}`;
                     document.getElementById('levelAmount').textContent = user.level || '-';
                }

                const taskList = document.getElementById('taskList');
                const noPackageMsg = document.getElementById('noPackageMsg');

                const activePackage = user ? user.activePackage : null;
                const level = user ? user.level : null;

                // Determine if package is active based on activePackage OR level
                const hasActivePackage = !!activePackage && !['none', 'null', ''].includes(String(activePackage).toLowerCase());
                const levelIndicatesActive = !!level && !['none', 'null', '', 'None'].includes(String(level).toLowerCase());

                const shouldShowTasks = hasActivePackage || levelIndicatesActive;

                // Debug log
                console.log('loadTaskState:', 'level:', level, 'activePackage:', activePackage, 'hasActivePackage:', hasActivePackage, 'levelIndicatesActive:', levelIndicatesActive, 'shouldShowTasks:', shouldShowTasks, 'completedTasks:', completedTasks);

                const taskResetTimerDiv = document.getElementById('taskResetTimer');

                if (shouldShowTasks) {
                    // If package is active (based on our check), update task list based on completed tasks
                    updateTaskList(completedTasks);
                    taskResetTimerDiv.style.display = '';
                    startTaskResetTimer(); // Start the timer
                } else {
                    // If no package is active, hide tasks and show message
                    taskList.style.display = 'none';
                    taskList.innerHTML = ''; // Ensure tasks are removed from DOM
                    noPackageMsg.textContent = 'You need an active package to complete tasks.';
                    noPackageMsg.style.display = '';
                    taskResetTimerDiv.style.display = 'none';
                    stopTaskResetTimer(); // Stop the timer
                }

            } catch (error) {
                console.error('Error loading task state:', error);
                // In case of error, hide tasks and show error message
                document.getElementById('taskList').style.display = 'none';
                document.getElementById('taskList').innerHTML = '';
                const noPackageMsg = document.getElementById('noPackageMsg');
                noPackageMsg.textContent = 'Failed to load tasks. Please try again.';
                noPackageMsg.style.display = '';
                document.getElementById('taskResetTimer').style.display = 'none';
                stopTaskResetTimer();
            }
        }

        let taskResetTimerInterval = null;

        async function startTaskResetTimer() {
            stopTaskResetTimer(); // Clear any existing timer
            const timerDiv = document.getElementById('taskResetTimer');
            if (!timerDiv) return;

            try {
                // Fetch initial time until next reset from backend
                const response = await fetch(`${API_URL}/tasks/minute-reset-time`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                if (!data.success || typeof data.timeUntilResetSeconds !== 'number') {
                    console.error('Failed to get time until reset');
                    timerDiv.textContent = 'Timer Sync Error';
                return;
            }
            
                let timeLeft = data.timeUntilResetSeconds;

                function updateTimerDisplay() {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDiv.textContent = `Tasks reset in: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    if (timeLeft <= 0) {
                        // Timer reached zero - trigger backend reset and refresh tasks
                        stopTaskResetTimer();
                        // Call backend to reset tasks (assuming an endpoint for this or it resets based on time)
                        // A simple approach: rely on the next loadTaskState or a dedicated reset endpoint.
                        // Let's assume backend automatically handles minute resets and fetching progress reflects it.
                        loadTaskState(); // Reload state to get new task count and restart timer
                    }

                    timeLeft--;
                }

                // Update immediately and then every second
                updateTimerDisplay();
                taskResetTimerInterval = setInterval(updateTimerDisplay, 1000);

            } catch (error) {
                console.error('Error starting task reset timer:', error);
                timerDiv.textContent = 'Timer Load Error';
            }
        }

        function stopTaskResetTimer() {
            if (taskResetTimerInterval) {
                clearInterval(taskResetTimerInterval);
                taskResetTimerInterval = null;
            }
        }

        // Show captcha modal
        let currentTaskId = null;
        async function showCaptcha(taskId) {
            currentTaskId = taskId;
            try {
                // Check daily task limit (backend also enforces this)
                const response = await fetch(`${API_URL}/tasks/check-limit`, {
                headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();

                if (!data.canPerformTask) {
                    document.getElementById('taskLimitMessage').style.display = 'block';
                    document.getElementById('taskResetTime').textContent = `Tasks reset in: ${data.timeUntilReset}`;
                    return;
                }

                const modal = document.getElementById('captchaModal');
                const content = document.getElementById('captchaContent');
                const captcha = generateCaptcha();
                content.textContent = captcha;
                modal.style.display = 'block';
                document.getElementById('captchaInput').focus();
                document.getElementById('taskLimitMessage').style.display = 'none'; // Hide limit message on new captcha
                document.getElementById('taskResetTime').textContent = '';

            } catch (error) {
                console.error('Error showing captcha:', error);
                alert('Error loading task. Please try again.');
            }
        }

        // Generate random captcha text
        function generateCaptcha() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
            let captcha = '';
            for (let i = 0; i < 6; i++) {
                captcha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return captcha;
        }

        // Verify captcha
        async function verifyCaptcha() {
            const input = document.getElementById('captchaInput');
            const content = document.getElementById('captchaContent');
            const modal = document.getElementById('captchaModal');
            const submitButton = modal.querySelector('button');

            if (input.value.toLowerCase() === content.textContent.toLowerCase()) {
                try {
                    // Save task completion to database
                    const response = await fetch(`${API_URL}/tasks/complete`, {
                    method: 'POST',
                    headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            taskType: 'captcha',
                            taskId: currentTaskId, // Pass task ID to backend
                            captchaText: content.textContent
                        })
                });

                const data = await response.json();

                if (data.success) {
                        // Update balance on the page
                        if (data.reward) {
                            const balanceElem = document.getElementById('balanceAmount');
                            let currentBalance = parseFloat(balanceElem.textContent.replace('$', '')) || 0;
                            currentBalance += parseFloat(data.reward);
                            balanceElem.textContent = `$${currentBalance.toFixed(2)}`;
                        }
                        // completeTask('captcha', submitButton); // Removed this - updateTaskList handles UI now
                        modal.style.display = 'none';
                        input.value = '';
                        currentTaskId = null; // Reset task ID

                        // Re-fetch progress and update task list
                        await loadTaskState();

                } else {
                        alert(data.message || 'Error completing task');
                }
            } catch (error) {
                    console.error('Error completing task:', error);
                    alert('Error completing task. Please try again.');
                }
            } else {
                alert('Incorrect! Try again.');
                content.textContent = generateCaptcha(); // Generate new captcha on failure
                input.value = '';
            }
        }

        // Close modal when clicking the X or Cancel button
        document.querySelector('.close').onclick = function() {
            document.getElementById('captchaModal').style.display = 'none';
            document.getElementById('captchaInput').value = '';
            document.getElementById('taskLimitMessage').style.display = 'none';
            document.getElementById('taskResetTime').textContent = '';
            currentTaskId = null; // Reset task ID
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('captchaModal');
            if (event.target === modal) {
                 document.getElementById('captchaModal').style.display = 'none';
                 document.getElementById('captchaInput').value = '';
                 document.getElementById('taskLimitMessage').style.display = 'none';
                 document.getElementById('taskResetTime').textContent = '';
                 currentTaskId = null; // Reset task ID
            }
        };

        // Handle keyboard events for captcha input (Enter key)
        document.getElementById('captchaInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyCaptcha();
            }
        });

        // Initialize and periodically update task state
        document.addEventListener('DOMContentLoaded', () => {
             loadTaskState(); // Load state on page load
             setInterval(loadTaskState, 30000); // Periodically check for updates (every 30 seconds)
        });

    </script>
</body>
</html>